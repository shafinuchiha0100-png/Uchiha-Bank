 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UCHIHA BANK</title>
<style>
    /* General */
    :root{
        --primary:#007bff;
        --primary-dark:#0056b3;
        --danger:#dc3545;
        --bg:#f5f9ff;
        --card:#ffffff;
        --muted:#6b7280;
        --shadow:0 6px 20px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background:linear-gradient(135deg,#f5f9ff,#e8f0ff);
        color:#333;
    }

    /* Intro */
    #intro{
        display:flex;align-items:center;justify-content:center;height:100vh;
        font-size:3em;font-weight:700;color:var(--primary);background:white;animation:fadeIn 1s ease-in-out;
    }

    /* Login Section */
    #login-section{
        display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;position:relative;padding:20px;
    }
    #login-section h1{color:var(--primary);margin-bottom:20px;font-size:2rem;}
    .top-right-btn{
        position:absolute;top:20px;right:20px;background:var(--primary);color:white;padding:8px 15px;border:none;border-radius:25px;cursor:pointer;transition:background .3s;
    }
    .top-right-btn:hover{background:var(--primary-dark);}
    .login-box{
        background:white;padding:30px;border-radius:15px;box-shadow:var(--shadow);text-align:center;width:100%;max-width:380px;animation:slideUp .7s ease-out;
    }
    .login-box h2{margin-bottom:15px;color:var(--primary);font-size:1.5rem;}
    .login-box input{
        display:block;margin:12px auto;padding:12px;width:90%;border:1px solid #ccc;border-radius:8px;font-size:1rem;transition:.3s;
    }
    .login-box input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 6px rgba(0,123,255,.4);}
    .login-actions{display:flex;gap:10px;margin-top:10px;justify-content:center;flex-wrap:wrap}
    .btn{background:var(--primary);color:#fff;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:1rem;transition:.3s}
    .btn:hover{background:var(--primary-dark);}
    .btn-outline{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .btn-outline:hover{background:#eef5ff}

    /* Panels */
    header{
        background:var(--primary);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;
    }
    header .logout{background:var(--danger);border:none;color:white;padding:8px 15px;border-radius:8px;cursor:pointer;transition:.3s;}
    header .logout:hover{background:#a71d2a;}
    main{padding:20px;}

    /* Cards */
    .card{background:var(--card);border-radius:12px;padding:20px;max-width:820px;margin:20px auto;box-shadow:var(--shadow);}

    /* User Panel */
    .user-card{display:flex;flex-direction:column;gap:15px;}
    .user-card h3{margin:0;color:var(--primary);font-size:1.4rem;}
    .user-card input,.user-card textarea{
        padding:12px;border:1px solid #ccc;border-radius:8px;width:100%;
    }
    .user-actions{display:flex;gap:10px;flex-wrap:wrap}
    .user-actions .btn{flex:1}

    /* Notice board */
    .notice-board{background:#fff8e6;border:1px solid #ffe7b8;color:#7a5a00;border-radius:12px;padding:14px;margin-bottom:16px}
    .notice-item{background:white;border:1px solid #f3e6bf;border-radius:10px;padding:10px;margin-top:8px}
    .notice-title{font-weight:600}
    .notice-meta{font-size:.85rem;color:#8a7b4c}

    /* Tables */
    .table-container{width:100%;overflow-x:auto;margin-top:10px;}
    table{width:100%;border-collapse:collapse;min-width:600px;border-radius:10px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,0.05)}
    th,td{padding:12px;text-align:center;border-bottom:1px solid #eee}
    th{background:var(--primary);color:white}
    tr:nth-child(even){background:#f9f9f9}
    .action-btn{padding:6px 10px;margin:2px;border:none;border-radius:6px;cursor:pointer}
    .edit-btn{background-color:#ffc107;color:#fff}
    .delete-btn{background-color:#dc3545;color:#fff}

    /* Popup / Modal */
    .popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:100}
    .popup-content{background:white;padding:20px;border-radius:12px;width:92%;max-width:420px;box-shadow:0 6px 20px rgba(0,0,0,.2);animation:scaleIn .25s ease-in-out;}
    .popup-content h3{margin-top:0;color:var(--primary)}
    .popup-content input,.popup-content textarea{width:100%;margin:8px 0;padding:12px;border:1px solid #ccc;border-radius:8px}

    /* Animations */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes scaleIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}

    /* Responsive */
    @media (max-width:480px){
        .login-box{padding:22px}
        th,td{font-size:12px}
        .action-btn{padding:4px 6px;font-size:12px}
        .card{margin:12px}
    }
</style>
</head>
<body>

<!-- Intro -->
<div id="intro">UCHIHA BANK</div>

<!-- Login -->
<div id="login-section">
    <button id="toggle-login" class="top-right-btn">Admin Login</button>
    <h1>UCHIHA BANK</h1>
    <div class="login-box">
        <h2 id="login-panel-title">User Login</h2>
        <input type="text" id="login-username" placeholder="Username"/>
        <input type="password" id="login-password" placeholder="Password"/>
        <div class="login-actions">
            <button class="btn" onclick="login()">Login</button>
        </div>
        
    </div>
</div>

<!-- User Panel -->
<div id="user-panel" style="display:none;">
    <header>
        <span>User Panel</span>
        <button class="logout" onclick="logout()">Logout</button>
    </header>
    <main>
        <div class="card">
            <!-- Notice board for users -->
            <div id="user-notices" class="notice-board">
                <div style="font-weight:600; margin-bottom:6px;">ðŸ“¢ Notice Board</div>
                <div id="user-announcement-list"></div>
            </div>

            <div class="user-card">
                <h3>Balance: $<span id="user-balance">0</span></h3>
                <input type="number" id="amount" placeholder="Amount"/>
                <textarea id="message" rows="2" placeholder="Message (optional)"></textarea>
                <div class="user-actions">
                    <button class="btn" onclick="requestTransaction('deposit')">Deposit</button>
                    <button class="btn" onclick="requestTransaction('withdraw')">Withdraw</button>
                </div>
            </div>
        </div>

        <div class="card">
            <!-- Transfer Section -->
            <div class="user-card">
                <h3>Transfer Money</h3>
                <input type="text" id="transfer-id" placeholder="Recipient User ID"/>
                <input type="number" id="transfer-amount" placeholder="Amount"/>
                <div class="user-actions">
                    <button class="btn" onclick="transferMoney()">Send</button>
                </div>
            </div>


            </div>
        </div>

        <div id="user-custombuttons-card" class="card" style="display:none;">
            <h3>Custom Buttons</h3>
            <div id="user-loginbuttons-list" class="user-card"></div>
        </div>

        
    </main>
</div>

<!-- Admin Panel -->
<div id="admin-panel" style="display:none;">
    <header>
        <span>Admin Panel</span>
        <button class="logout" onclick="logout()">Logout</button>
    </header>
    <main>
        <div class="card">
            <h3 style="margin:0 0 10px;">Users</h3>
            <button class="btn" onclick="openUserPopup()">Add User</button>
            <div class="table-container" style="margin-top:10px;">
                <table id="user-table">
                    <tr><th>ID</th><th>Username</th><th>Password</th><th>Balance</th><th>Action</th></tr>
                </table>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Deposit Requests</h3>
            <ul id="deposit-requests" style="list-style:none; padding-left:0;"></ul>
            <h3>Withdraw Requests</h3>
            <ul id="withdraw-requests" style="list-style:none; padding-left:0;"></ul>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Login Page Buttons (Admin Control)</h3>
            <div id="admin-loginbuttons-list" class="notice-board"></div>
            <div class="user-card">
                <input type="text" id="btn-title" placeholder="Button Name"/>
                <input type="text" id="btn-link" placeholder="Button Link"/>
                <div class="user-actions">
                    <button class="btn" onclick="saveLoginButton()">Save</button>
                    <button class="btn btn-outline" onclick="clearLoginButtonForm()">Clear</button>
                </div>
                <input type="hidden" id="btn-edit-key" />
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Announcements (Admin Control)</h3>
            <div class="notice-board">
                <div style="font-weight:600; margin-bottom:6px;">Current Announcements</div>
                <div id="admin-announcement-list"></div>
            </div>
            <div class="user-card">
                <input type="text" id="ann-title" placeholder="Title"/>
                <textarea id="ann-message" rows="3" placeholder="Message"></textarea>
                <div class="user-actions">
                    <button class="btn" onclick="saveAnnouncement()">Post / Update</button>
                    <button class="btn btn-outline" onclick="clearAnnouncementForm()">Clear</button>
                </div>
                <input type="hidden" id="ann-edit-key" />
            </div>
        </div>
    </main>
</div>

<!-- Popup: Add/Edit User -->
<div class="popup" id="user-popup">
    <div class="popup-content">
        <h3 id="popup-title">Add User</h3>
        <input type="text" id="popup-id" placeholder="ID"/>
        <input type="text" id="popup-username" placeholder="Username"/>
        <input type="text" id="popup-password" placeholder="Password"/>
        <input type="number" id="popup-balance" placeholder="Balance"/>
        <div class="user-actions">
            <button class="btn" onclick="saveUser()">Save</button>
            <button class="btn btn-outline" onclick="closePopup()">Cancel</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js">
/* ---------------- User: Direct Transfer ---------------- */
function transferMoney(){
    let recipientId = document.getElementById('transfer-id').value.trim();
    let amount = parseFloat(document.getElementById('transfer-amount').value);
    if(!recipientId || isNaN(amount) || amount <= 0){ alert('Invalid input'); return; }

    db.ref("users").once("value").then(snapshot=>{
        let users = snapshot.val() || {};
        let senderKey = currentUser._key;
        let recipientKey = Object.keys(users).find(k => users[k].id === recipientId);
        if(!recipientKey){ alert('Recipient not found'); return; }

        let sender = users[senderKey];
        let recipient = users[recipientKey];
        if(sender.balance < amount){ alert('Insufficient balance'); return; }

        sender.balance -= amount;
        recipient.balance += amount;

        db.ref("users/"+senderKey).set(sender);
        db.ref("users/"+recipientKey).set(recipient);
        currentUser.balance = sender.balance;
        document.getElementById('user-balance').textContent = sender.balance;
        alert('Transfer successful');
        document.getElementById('transfer-id').value='';
        document.getElementById('transfer-amount').value='';
    });
}
</script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js">
/* ---------------- User: Direct Transfer ---------------- */
function transferMoney(){
    let recipientId = document.getElementById('transfer-id').value.trim();
    let amount = parseFloat(document.getElementById('transfer-amount').value);
    if(!recipientId || isNaN(amount) || amount <= 0){ alert('Invalid input'); return; }

    db.ref("users").once("value").then(snapshot=>{
        let users = snapshot.val() || {};
        let senderKey = currentUser._key;
        let recipientKey = Object.keys(users).find(k => users[k].id === recipientId);
        if(!recipientKey){ alert('Recipient not found'); return; }

        let sender = users[senderKey];
        let recipient = users[recipientKey];
        if(sender.balance < amount){ alert('Insufficient balance'); return; }

        sender.balance -= amount;
        recipient.balance += amount;

        db.ref("users/"+senderKey).set(sender);
        db.ref("users/"+recipientKey).set(recipient);
        currentUser.balance = sender.balance;
        document.getElementById('user-balance').textContent = sender.balance;
        alert('Transfer successful');
        document.getElementById('transfer-id').value='';
        document.getElementById('transfer-amount').value='';
    });
}
</script>

<script>
/* ---------------- Firebase (your original project) ---------------- */
var firebaseConfig = {
  apiKey: "AIzaSyAR26sPK3nwUHZPfsea3pt7skQRRfaNsx0",
  authDomain: "uchihabankltd.firebaseapp.com",
  databaseURL: "https://uchihabankltd-default-rtdb.firebaseio.com",
  projectId: "uchihabankltd",
  storageBucket: "uchihabankltd.firebasestorage.app",
  messagingSenderId: "148914643516",
  appId: "1:148914643516:web:cf6d15ea20f929a9a71939"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

/* ---------------- State ---------------- */
let isAdmin = false;
let currentUser = null;
let editKey = null;      // users
let annEditKey = null;   // announcements

/* ---------------- Intro & Login Toggle ---------------- */
function showIntro(){
    setTimeout(()=>{
        document.getElementById('intro').style.display='none';
        document.getElementById('login-section').style.display='flex';
    }, 1200);
}
showIntro();

document.getElementById('toggle-login').onclick = function(){
    isAdmin = !isAdmin;
    document.getElementById('login-panel-title').textContent = isAdmin ? 'Admin Login' : 'User Login';
    this.textContent = isAdmin ? 'User Login' : 'Admin Login';
};

/* ---------------- Login / Logout ---------------- */
function login(){
    let username = document.getElementById('login-username').value.trim();
    let password = document.getElementById('login-password').value;

    if(isAdmin){
        if(username==='admin' && password==='admin123'){
            document.getElementById('login-section').style.display='none';
            document.getElementById('admin-panel').style.display='block';
            document.getElementById('user-panel').style.display='none';
            loadUsers();
            renderRequests();
            listenAnnouncements(); // start live list for admin
            listenLoginButtons();
        }else{
            alert('Invalid admin credentials');
        }
    }else{
        db.ref("users").once("value").then(snapshot=>{
            let users = snapshot.val() || {};
            let foundUser = null;
            Object.entries(users).forEach(([key,u])=>{
                if(u.username===username && u.password===password){ foundUser = {...u, _key:key}; }
            });
            if(foundUser){
                currentUser = foundUser;
                document.getElementById('login-section').style.display='none';
                document.getElementById('user-panel').style.display='block';
                document.getElementById('admin-panel').style.display='none';
                document.getElementById('user-balance').textContent = foundUser.balance;
                listenAnnouncements(); // start live list for user
                listenLoginButtons();
            }else{
                alert('Invalid user credentials');
            }
        });
    }
}

function logout(){
    currentUser = null;
    document.getElementById('user-panel').style.display='none';
    document.getElementById('admin-panel').style.display='none';
    document.getElementById('login-section').style.display='flex';
    document.getElementById('login-username').value='';
    document.getElementById('login-password').value='';
}

/* ---------------- User: Transaction Requests ---------------- */
function requestTransaction(type){
    let amount = parseFloat(document.getElementById('amount').value);
    let message = document.getElementById('message').value;
    if(isNaN(amount)||amount<=0){ alert('Invalid amount'); return; }
    let req = { user: currentUser.username, amount, message };
    db.ref(type + "Requests").push(req);
    alert('Request sent to admin');
    document.getElementById('amount').value='';
    document.getElementById('message').value='';
}

/* ---------------- Admin: Users CRUD ---------------- */
function loadUsers(){
    let table = document.getElementById('user-table');
    table.innerHTML = '<tr><th>ID</th><th>Username</th><th>Password</th><th>Balance</th><th>Action</th></tr>';
    db.ref("users").on("value", snapshot=>{
        let users = snapshot.val() || {};
        table.innerHTML = '<tr><th>ID</th><th>Username</th><th>Password</th><th>Balance</th><th>Action</th></tr>';
        Object.entries(users).forEach(([key,u])=>{
            table.innerHTML += `<tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.password}</td>
                <td>${u.balance}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="editUser('${key}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteUser('${key}')">Delete</button>
                </td>
            </tr>`;
        });
    });
}

function openUserPopup(){
    editKey=null;
    document.getElementById('popup-title').textContent='Add User';
    document.getElementById('popup-id').value='';
    document.getElementById('popup-username').value='';
    document.getElementById('popup-password').value='';
    document.getElementById('popup-balance').value='';
    document.getElementById('user-popup').style.display='flex';
}
function editUser(key){
    db.ref("users/"+key).once("value").then(s=>{
        let u=s.val(); if(!u) return;
        editKey=key;
        document.getElementById('popup-title').textContent='Edit User';
        document.getElementById('popup-id').value=u.id;
        document.getElementById('popup-username').value=u.username;
        document.getElementById('popup-password').value=u.password;
        document.getElementById('popup-balance').value=u.balance;
        document.getElementById('user-popup').style.display='flex';
    });
}
function deleteUser(key){
    if(confirm('Delete this user?')){
        db.ref("users/"+key).remove();
    }
}
function saveUser(){
    let id=document.getElementById('popup-id').value.trim();
    let username=document.getElementById('popup-username').value.trim();
    let password=document.getElementById('popup-password').value;
    let balance=parseFloat(document.getElementById('popup-balance').value)||0;
    if(!id||!username||!password){ alert('Fill all fields'); return; }
    let newUser={id,username,password,balance};
    if(editKey) db.ref("users/"+editKey).set(newUser);
    else db.ref("users").push(newUser);
    editKey=null; closePopup();
}
function closePopup(){ document.getElementById('user-popup').style.display='none'; }

/* ---------------- Admin: Requests ---------------- */
function renderRequests(){
    db.ref("depositRequests").on("value", snapshot=>{
        let list=document.getElementById('deposit-requests'); list.innerHTML='';
        let reqs = snapshot.val() || {};
        Object.entries(reqs).forEach(([key,r])=>{
            list.innerHTML += `<li class="notice-item">
                <span><b>${r.user}</b> requests <b>deposit</b> $${r.amount} â€” ${r.message||''}</span>
                <div style="margin-top:6px;">
                    <button class="action-btn edit-btn" onclick="approveRequest('deposit','${key}')">Approve</button>
                    <button class="action-btn delete-btn" onclick="rejectRequest('deposit','${key}')">Reject</button>
                </div>
            </li>`;
        });
    });

    db.ref("withdrawRequests").on("value", snapshot=>{
        let list=document.getElementById('withdraw-requests'); list.innerHTML='';
        let reqs = snapshot.val() || {};
        Object.entries(reqs).forEach(([key,r])=>{
            list.innerHTML += `<li class="notice-item">
                <span><b>${r.user}</b> requests <b>withdraw</b> $${r.amount} â€” ${r.message||''}</span>
                <div style="margin-top:6px;">
                    <button class="action-btn edit-btn" onclick="approveRequest('withdraw','${key}')">Approve</button>
                    <button class="action-btn delete-btn" onclick="rejectRequest('withdraw','${key}')">Reject</button>
                </div>
            </li>`;
        });
    });
}
function approveRequest(type,key){
    db.ref(type+"Requests/"+key).once("value").then(snap=>{
        let req=snap.val(); if(!req) return;
        db.ref("users").once("value").then(snapshot=>{
            let users=snapshot.val()||{};
            let userKey = Object.keys(users).find(k=>users[k].username===req.user);
            if(userKey){
                let user=users[userKey];
                if(type==='deposit'){ user.balance += Number(req.amount); }
                else{
                    if(user.balance>=req.amount){ user.balance -= Number(req.amount); }
                    else{ alert('Insufficient balance'); return; }
                }
                db.ref("users/"+userKey).set(user);
                db.ref(type+"Requests/"+key).remove();
            }
        });
    });
}
function rejectRequest(type,key){ db.ref(type+"Requests/"+key).remove(); }

/* ---------------- Login Page Buttons ---------------- */
function listenLoginButtons(){
    db.ref('loginButtons').on('value', snap => {
        const items = snap.val() || {};
        let html = '';
        Object.entries(items).forEach(([key,btn]) => {
            html += `<button class="btn" onclick="window.location.href='${btn.link}'">${btn.title}</button>`;
        });
        if(currentUser){ document.getElementById('user-custombuttons-card').style.display='block'; document.getElementById('user-loginbuttons-list').innerHTML = html; } else { document.getElementById('user-custombuttons-card').style.display='none'; }
        if(isAdmin){
            let adminList = '';
            Object.entries(items).forEach(([key,btn])=>{
                adminList += `<div class='notice-item'><b>${btn.title}</b> â†’ ${btn.link}
                <div class='user-actions'>
                    <button class='btn' onclick="startEditLoginButton('${key}','${btn.title}','${btn.link}')">Edit</button>
                    <button class='btn btn-outline' onclick="deleteLoginButton('${key}')">Delete</button>
                </div></div>`;
            });
            document.getElementById('admin-loginbuttons-list').innerHTML = adminList || '<div>No buttons yet.</div>';
        }
    });
}

function saveLoginButton(){
    const title = document.getElementById('btn-title').value.trim();
    const link = document.getElementById('btn-link').value.trim();
    if(!title || !link){ alert('Fill all fields'); return; }
    const editId = document.getElementById('btn-edit-key').value;
    if(editId){ db.ref('loginButtons/'+editId).update({title,link}); }
    else { db.ref('loginButtons').push({title,link}); }
    clearLoginButtonForm();
}

function startEditLoginButton(key,title,link){
    document.getElementById('btn-title').value = title;
    document.getElementById('btn-link').value = link;
    document.getElementById('btn-edit-key').value = key;
}

function deleteLoginButton(key){ db.ref('loginButtons/'+key).remove(); }

function clearLoginButtonForm(){
    document.getElementById('btn-title').value='';
    document.getElementById('btn-link').value='';
    document.getElementById('btn-edit-key').value='';
}

/* ---------------- Announcements (List) ---------------- */
// Live listeners for both login modal, user panel, and admin list
function listenAnnouncements(){
    db.ref("announcements").orderByChild("createdAt").on("value", snap=>{
        const items = [];
        snap.forEach(child=>{
            items.push({key:child.key, ...child.val()});
        });
        items.sort((a,b)=>b.createdAt-a.createdAt); // latest first
        renderAnnouncementLists(items);
    });
}
function renderAnnouncementLists(items){
    const format = (item) => `
        <div class="notice-item">
            <div class="notice-title">ðŸ”” ${item.title||'Untitled'}</div>
            <div>${item.message||''}</div>
            <div class="notice-meta">${new Date(item.createdAt).toLocaleString()}</div>
            ${isAdmin ? `
            <div class="user-actions" style="margin-top:8px">
                <button class="btn" onclick="startEditAnnouncement('${item.key}','${escapeQuotes(item.title||'')}','${escapeQuotes(item.message||'')}')">Edit</button>
                <button class="btn btn-outline" onclick="deleteAnnouncement('${item.key}')">Delete</button>
            </div>` : ``}
        </div>`;

    // Admin list
    const adminList = document.getElementById('admin-announcement-list');
    if(adminList){ adminList.innerHTML = items.length? items.map(format).join('') : '<div class="notice-item">No announcements yet.</div>'; }

    // User panel list
    const userList = document.getElementById('user-announcement-list');
    if(userList){ userList.innerHTML = items.length? items.map(format).join('') : '<div>No announcements yet.</div>'; }

    // Login modal list
    const loginList = document.getElementById('login-announcement-list');
    if(loginList){ loginList.innerHTML = items.length? items.map(format).join('') : '<div>No announcements yet.</div>'; }
}
function escapeQuotes(s){ return (s||'').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

function saveAnnouncement(){
    const title = document.getElementById('ann-title').value.trim();
    const message = document.getElementById('ann-message').value.trim();
    if(!title && !message){ alert('Write a title or message'); return; }

    const payload = { title, message, createdAt: Date.now() };

    const editId = document.getElementById('ann-edit-key').value;
    if(editId){
        db.ref("announcements/"+editId).update(payload);
    }else{
        db.ref("announcements").push(payload);
    }
    clearAnnouncementForm();
}
function startEditAnnouncement(key,title,message){
    annEditKey = key;
    document.getElementById('ann-title').value = title.replaceAll('&quot;','"').replaceAll('&#39;',"'");
    document.getElementById('ann-message').value = message.replaceAll('&quot;','"').replaceAll('&#39;',"'");
    document.getElementById('ann-edit-key').value = key;
    // scroll to form
    window.scrollTo({top:document.getElementById('ann-title').getBoundingClientRect().top + window.pageYOffset - 90, behavior:'smooth'});
}
function deleteAnnouncement(key){
    if(confirm('Delete this announcement?')){
        db.ref("announcements/"+key).remove();
        if(document.getElementById('ann-edit-key').value===key){ clearAnnouncementForm(); }
    }
}
function clearAnnouncementForm(){
    annEditKey=null;
    document.getElementById('ann-title').value='';
    document.getElementById('ann-message').value='';
    document.getElementById('ann-edit-key').value='';
}

/* ---------------- User: Direct Transfer ---------------- */
function transferMoney(){
    let recipientId = document.getElementById('transfer-id').value.trim();
    let amount = parseFloat(document.getElementById('transfer-amount').value);
    if(!recipientId || isNaN(amount) || amount <= 0){ alert('Invalid input'); return; }

    db.ref("users").once("value").then(snapshot=>{
        let users = snapshot.val() || {};
        let senderKey = currentUser._key;
        let recipientKey = Object.keys(users).find(k => users[k].id === recipientId);
        if(!recipientKey){ alert('Recipient not found'); return; }

        let sender = users[senderKey];
        let recipient = users[recipientKey];
        if(sender.balance < amount){ alert('Insufficient balance'); return; }

        sender.balance -= amount;
        recipient.balance += amount;

        db.ref("users/"+senderKey).set(sender);
        db.ref("users/"+recipientKey).set(recipient);
        currentUser.balance = sender.balance;
        document.getElementById('user-balance').textContent = sender.balance;
        alert('Transfer successful');
        document.getElementById('transfer-id').value='';
        document.getElementById('transfer-amount').value='';
    });
}
</script>
</body>
</html>
